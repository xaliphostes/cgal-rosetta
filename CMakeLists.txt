# ============================================================================
# CMakeLists.txt for cgal-rosetta
# ============================================================================
# Generated by rosetta-create
#
# Usage:
#   mkdir build && cd build
#   cmake ..
#   make
#   ./cgal_rosetta_generator project.json
# ============================================================================

cmake_minimum_required(VERSION 3.16)
project(cgal_rosetta_binding_generator VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ============================================================================
# FetchContent for dependencies
# ============================================================================
include(FetchContent)

# ----------------------------------------------------------------------------
# Rosetta Library (use local version)
# ----------------------------------------------------------------------------
message(STATUS "Using local Rosetta library...")
set(ROSETTA_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../rosetta")
set(ROSETTA_INCLUDE_DIR "${ROSETTA_SOURCE_DIR}/include")

# Disable Rosetta unit tests
set(BUILD_TESTING OFF CACHE BOOL "" FORCE)

add_subdirectory(${ROSETTA_SOURCE_DIR} ${CMAKE_BINARY_DIR}/_deps/rosetta-build)

# ----------------------------------------------------------------------------
# cgal Library (fetched from GitHub)
# ----------------------------------------------------------------------------
message(STATUS "Fetching cgal library...")
FetchContent_Declare(
    cgal
    GIT_REPOSITORY https://github.com/CGAL/cgal.git
    GIT_TAG        main
    GIT_SHALLOW    TRUE
)

# Disable tests for fetched library
set(BUILD_TESTING OFF CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(cgal)
FetchContent_GetProperties(cgal SOURCE_DIR CGAL_SOURCE_DIR)
set(CGAL_INCLUDE_DIR "${CGAL_SOURCE_DIR}/include")
set(CGAL_SRC_DIR "${CGAL_SOURCE_DIR}/src")

# ----------------------------------------------------------------------------
# nlohmann_json (for configuration parsing)
# ----------------------------------------------------------------------------
find_package(nlohmann_json 3.9 QUIET)
if(NOT nlohmann_json_FOUND)
    message(STATUS "Fetching nlohmann_json...")
    FetchContent_Declare(
        nlohmann_json
        GIT_REPOSITORY https://github.com/nlohmann/json.git
        GIT_TAG        v3.11.3
        GIT_SHALLOW    TRUE
    )
    FetchContent_MakeAvailable(nlohmann_json)
endif()

# ----------------------------------------------------------------------------
# CGAL (brings in GMP and MPFR dependencies)
# ----------------------------------------------------------------------------
find_package(CGAL REQUIRED)

# ============================================================================
# Generator executable
# ============================================================================
add_executable(cgal_rosetta_generator
    main.cxx
)

# Place the executable in a convenient location
set_target_properties(cgal_rosetta_generator PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/.."
)

# Include directories
target_include_directories(cgal_rosetta_generator PRIVATE
    # Rosetta
    ${ROSETTA_INCLUDE_DIR}

    # cgal library headers
    ${CGAL_INCLUDE_DIR}
    ${CGAL_SRC_DIR}

    # Local bindings directory
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/bindings
)

# Link libraries
target_link_libraries(cgal_rosetta_generator PRIVATE
    nlohmann_json::nlohmann_json
    CGAL::CGAL
)

# ============================================================================
# Print configuration summary
# ============================================================================
message(STATUS "")
message(STATUS "============================================================")
message(STATUS "cgal-rosetta Binding Generator Configuration")
message(STATUS "============================================================")
message(STATUS "  cgal source:      ${CGAL_SOURCE_DIR}")
message(STATUS "  Rosetta include:      ${ROSETTA_INCLUDE_DIR}")
message(STATUS "============================================================")
message(STATUS "")
message(STATUS "  1. Build: cmake --build .")
message(STATUS "  2. Run: ./cgal_rosetta_generator project.json")
